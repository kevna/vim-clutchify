#!/usr/bin/env python

import sys
from xinput import operate_xinput_device, MODE_ENABLE, MODE_DISABLE
import evdev
from evdev import UInput, InputEvent, ecodes as e
import re
from time import sleep

def main():
    devices = [evdev.InputDevice(fn) for fn in evdev.list_devices()]
    device = next(x for x in devices if re.search("FootSwitch", x.name))
    operate_xinput_device(MODE_DISABLE, device.name)
    with UInput() as ui:
        try:
            for event in device.read_loop():
                if event.type == evdev.ecodes.EV_KEY:
                    if event.value == 1:
                        ui.write(e.EV_KEY, e.KEY_ESC, 1)
                        ui.write(e.EV_KEY, e.KEY_ESC, 0)
                        ui.syn()
                        sleep(0.01)
                        ui.write(e.EV_KEY, e.KEY_A, 1)
                        ui.write(e.EV_KEY, e.KEY_A, 0)
                        ui.syn()
                    elif event.value == 0:
                        ui.write(e.EV_KEY, e.KEY_ESC, 1)
                        ui.write(e.EV_KEY, e.KEY_ESC, 0)
                        ui.syn()
        finally:
            operate_xinput_device(MODE_ENABLE, device.name)

if __name__ == "__main__":
    main()
