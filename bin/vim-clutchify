#!/usr/bin/env python

import sys
from xinput import operate_xinput_device, MODE_ENABLE, MODE_DISABLE
import evdev
from evdev import UInput, InputEvent, ecodes as e
import re
from time import sleep

def tap(ui, key):
    key = getattr(e, "KEY_%s" % key.upper())
    ui.write(e.EV_KEY, key, 1)
    ui.write(e.EV_KEY, key, 0)
    ui.syn()

def main():
    devices = [evdev.InputDevice(fn) for fn in evdev.list_devices()]
    device = next(x for x in devices if re.search("FootSwitch", x.name))
    operate_xinput_device(MODE_DISABLE, device.name)
    with UInput() as ui:
        try:
            for event in device.read_loop():
                if event.type == evdev.ecodes.EV_KEY:
                    if event.value == 1:
                        tap(ui, "esc")
                        sleep(0.01)
                        tap(ui, "a")
                    elif event.value == 0:
                        tap(ui, "esc")
        finally:
            operate_xinput_device(MODE_ENABLE, device.name)

if __name__ == "__main__":
    main()
